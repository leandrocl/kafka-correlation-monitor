# ⚠️ AI-GENERATED PROJECT DISCLAIMER

**This entire project was created leveraging generative AI, specifically the Cursor platform, as a personal discovery and proof of concept initiated by the repository's owner without him writing a single line of code by himself.**

**Visitors are welcome to clone, fork, change the project and use at their own risk. There are no commitments or responsibilities assumed by the repository owner.**

---

## Kafka Correlation Monitor

A comprehensive Spring Boot REST API that implements Kafka correlation monitoring and event processing. The application dynamically consumes messages from Kafka topics, extracts keys of interest, persists interesting events, and correlates them across related topics.

## Features

- **Spring Boot 3.2.0** with Java 21
- **Apache Kafka** integration with dynamic topic consumption
- **HSQLDB** with persistent local storage and Flyway migrations
- **Dynamic Kafka Consumers** with configurable topics and correlation logic
- **Event Correlation** across main and correlated topics
- **Scheduled Cleanup** of correlated events
- **Event Monitoring** for uncorrelated events
- **REST API** with pagination and event management
- **OpenAPI/Swagger** documentation
- **Actuator** endpoints for monitoring

## Key Components

### Kafka Correlation System

- **Dynamic Topic Configuration**: Configure topics with keys of interest and correlated topics
- **Event Persistence**: Automatically persist events with keys of interest to database
- **Correlation Logic**: Match events across main and correlated topics
- **Real-time Processing**: Process messages as they arrive from Kafka

### Scheduled Tasks

- **Cleanup Scheduler**: Automatically removes correlated events (configurable interval)
- **Monitor Scheduler**: Tracks uncorrelated events older than threshold (configurable)

### Database Management

- **Flyway Migrations**: Automated database schema management
- **HSQLDB**: Lightweight, file-based database
- **Event Storage**: Persistent storage of interesting events with correlation data

## Prerequisites

- Java 21 or higher
- Maven 3.6 or higher
- Apache Kafka (running on localhost:9092 by default)

## Quick Start

### 1. Clone and Build

```bash
git clone https://github.com/leandrocl/kafka-correlation-monitor.git
cd kafka-correlation-monitor
mvn clean install
```

### 2. Start Kafka (if not running)

```bash
# Using Docker
docker run -p 9092:9092 apache/kafka:2.13-3.6.1

# Or using local Kafka installation
# Start Zookeeper and Kafka brokers
```

### 3. Run the Application

```bash
mvn spring-boot:run
```

The application will start on `http://localhost:8080`

## Configuration

### Kafka Topics Configuration

The application supports dynamic topic configuration in `application.yml`:

```yaml
kafka:
  topics:
    - name: test-topic
      consumer-group: test-consumer-group
      correlated-topic: test-topic-correlated
      key-of-interest: userId
      correlated-key-of-interest: correlationId
    - name: user-events
      consumer-group: user-events-consumer-group
      correlated-topic: user-events-correlated
      key-of-interest: userEmail
      correlated-key-of-interest: transactionId
```

### Scheduler Configuration

```yaml
scheduler:
  cleanup:
    interval-seconds: 60  # Cleanup correlated events every 60 seconds
  monitor:
    interval-seconds: 30  # Monitor uncorrelated events every 30 seconds
    age-threshold-seconds: 300  # Events older than 5 minutes
```

## API Endpoints

### Health Check

- **GET** `/api/v1/health`
- Tests database connectivity
- Returns HTTP 200 if healthy, 503 if unhealthy

### Kafka Producer

- **POST** `/api/v1/kafka/produce`
- Send messages to Kafka topics
- Request body: `{"kafkaTopic": "topic-name", "message": "JSON message"}`

### Interesting Events

- **GET** `/api/v1/interesting-events`
- List all interesting events with pagination
- Query parameters: `offset`, `limit`

## Testing the Correlation System

### 1. Send a message to a main topic

```bash
curl -X POST "http://localhost:8080/api/v1/kafka/produce" \
  -H "Content-Type: application/json" \
  -d '{"kafkaTopic": "test-topic", "message": "{\"userId\":\"user123\",\"message\":\"Test message\"}"}'
```

### 2. Send a correlated message

```bash
curl -X POST "http://localhost:8080/api/v1/kafka/produce" \
  -H "Content-Type: application/json" \
  -d '{"kafkaTopic": "test-topic-correlated", "message": "{\"correlationId\":\"user123\",\"message\":\"Correlated message\"}"}'
```

### 3. Check the events

```bash
curl "http://localhost:8080/api/v1/interesting-events"
```

## Database Schema

### Interesting Events Table

```sql
CREATE TABLE interesting_events (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    topic_name VARCHAR(100) NOT NULL,
    key_of_interest_name VARCHAR(100) NOT NULL,
    key_of_interest_value VARCHAR(500) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    correlated_message VARCHAR(1000),
    is_correlated BOOLEAN DEFAULT FALSE,
    correlation_timestamp TIMESTAMP DEFAULT NULL
);
```

## Monitoring and Logging

### Log Files

- **Location**: `output.log` in project root
- **Rotation**: Daily with 30-day retention
- **Size Limit**: 3GB total

### Scheduler Logs

- **Cleanup**: Logs number of correlated events deleted
- **Monitor**: Logs uncorrelated events count by topic

### Example Log Output

```bash
Starting cleanup of correlated events from interesting_events table...
Cleanup completed successfully. Deleted 1 correlated event records from interesting_events table.

Starting monitoring of uncorrelated events older than 300 seconds...
Found 2 topics with uncorrelated events older than 300 seconds:
Topic: 'test-topic' - Uncorrelated events count: 3
Topic: 'user-events' - Uncorrelated events count: 1
```

## Project Structure

```bash
src/
├── main/
│   ├── java/com/example/restapi/
│   │   ├── RestApiApplication.java              # Main application class
│   │   ├── config/
│   │   │   ├── KafkaConfig.java                 # Kafka configuration
│   │   │   └── KafkaTopicConfig.java            # Topic configuration
│   │   ├── controller/
│   │   │   ├── ApiController.java               # Health endpoints
│   │   │   ├── KafkaController.java             # Kafka producer endpoints
│   │   │   └── InterestingEventController.java  # Event management
│   │   ├── entity/
│   │   │   └── InterestingEvent.java            # Event entity
│   │   ├── repository/
│   │   │   └── InterestingEventRepository.java  # Data access
│   │   └── service/
│   │       ├── DynamicKafkaConsumerService.java # Kafka consumers
│   │       ├── InterestingEventService.java     # Event processing
│   │       ├── InterestingEventCleanupScheduler.java    # Cleanup scheduler
│   │       └── InterestingEventMonitorScheduler.java    # Monitor scheduler
│   └── resources/
│       ├── application.yml                      # Application configuration
│       ├── logback-spring.xml                  # Logging configuration
│       └── db/migration/                       # Flyway migrations
└── test/
    └── java/com/example/restapi/               # Test classes
```

## Development

### Running Tests

```bash
mvn test
```

### Building JAR

```bash
mvn clean package
```

### Running JAR

```bash
java -jar target/rest-api-1.0.0.jar
```

### Database Reset

```bash
rm -rf data/
mvn flyway:migrate
```

## Configuration Options

### Kafka Configuration

- **Bootstrap Servers**: `localhost:9092` (configurable)
- **Consumer Groups**: Separate groups for main and correlated topics
- **Auto Offset Reset**: `earliest`
- **Enable Auto Commit**: `false`

### Database Configuration

- **Type**: HSQLDB with file persistence
- **Location**: `./data/restapi`
- **Migrations**: Automatic via Flyway

### Scheduler Parameters

- **Cleanup Interval**: 60 seconds (configurable)
- **Monitor Interval**: 30 seconds (configurable)
- **Age Threshold**: 300 seconds (configurable)

## Troubleshooting

### Kafka Connection Issues

- Ensure Kafka is running on `localhost:9092`
- Check topic configuration in `application.yml`
- Verify consumer groups are properly configured

### Database Issues

- Check if the `./data` directory is writable
- Run `mvn flyway:migrate` to apply migrations
- Verify HSQLDB configuration in `application.yml`

### Scheduler Issues

- Check logs for scheduler execution
- Verify configuration values in `application.yml`
- Ensure database connectivity

## License

This project is for educational purposes.